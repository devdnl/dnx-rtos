/*==============================================================================
File    ttyread.c

Author  Daniel Zorychta

Brief   TTY reader

        Copyright (C) 3DGence 2020 Daniel Zorychta <daniel.zorychta@gmail.com>

==============================================================================*/

/*==============================================================================
  Include files
==============================================================================*/
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdbool.h>
#include <sys/ioctl.h>

/*==============================================================================
  Local macros
==============================================================================*/

/*==============================================================================
  Local object types
==============================================================================*/

/*==============================================================================
  Local function prototypes
==============================================================================*/

/*==============================================================================
  Local objects
==============================================================================*/
GLOBAL_VARIABLES_SECTION {
        char buf[__TTY_TERM_COLS__ * __TTY_TERM_ROWS__];
};

/*==============================================================================
  Exported objects
==============================================================================*/
PROGRAM_PARAMS(ttyread, STACK_DEPTH_VERY_LOW);

/*==============================================================================
  External objects
==============================================================================*/

/*==============================================================================
  Function definitions
==============================================================================*/

//==============================================================================
/**
 * Main program function.
 *
 * Note: Please adjust stack size according to programs needs.
 *
 * @param argc      argument count
 * @param argv      arguments
 */
//==============================================================================
int main(int argc, char *argv[])
{
        if (argc < 2) {
                printf("Usage: %s <tty-file>\n", argv[0]);
                return EXIT_FAILURE;

        } else {
                FILE *tty = fopen(argv[1], "r");
                if (tty) {

                        TTY_buffer_t buf;
                        buf.ptr  = global->buf;
                        buf.size = sizeof(global->buf);

                        int err = ioctl(fileno(tty), IOCTL_TTY__READ_BUFFER, &buf);
                        if (!err) {
                                fwrite(global->buf, 1, sizeof(global->buf) - buf.size, stdout);

                        } else {
                                perror(argv[1]);
                        }

                        fclose(tty);
                } else {
                        perror(argv[1]);
                }
        }

        return EXIT_SUCCESS;
}

/*==============================================================================
  End of file
==============================================================================*/

